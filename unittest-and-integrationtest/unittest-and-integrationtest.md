# 단위테스트와 통합테스트

최근 면접 자리에서 스프링 프레임워크 위에서 단위 테스트를 수행할 때, 테스트 대상 메소드에서 다른 클래스를 의존하고, 그 클래스는 또 다른 클래스를 의존하는 식으로 의존 관계가 깊이 얽히게 되는 것에 대해 어떻게 생각하냐는 질문을 받았다.

이전까지 단순히 개인적으로만 테스트 코드를 작성해왔기에 내가 작성한 코드의 검증 관점에서만 생각 했지 단위 테스트의 진정한 목적은 무엇인가, 단위 테스트의 단위는 어디까지인가에 대해 깊이 있게 고민해보지 않았다. 또한, 최근에 객체지향프로그래밍에 대해 집중적으로 학습 하다 보니, 캡슐화 개념을 단위테스트에 대입시켜버렸다. 즉, 객체지향프로그래밍 관점에서는 내부적으로 어떻게 요청을 처리하든 입력(input)에 대한 출력(output)이 중요하다고 생각하며, 원래 테스트 하려는 범위를 벗어나기는 하지만 이 테스트 자체로도 나름의 의미를 가지는 테스트가 되지 않겠냐고 대답했다.

최근 스프링프레임워크를 다시 학습하기 위해 [토비의 스프링](http://book.naver.com/bookdb/book_detail.nhn?bid=7006516)을 보고 있다. 이 책은 단순한 예제를 스프링 기술을 적용하며 발전시켜 나가면서 스프링을 이해하게 도와준다. 그리고 단위 테스트도 계속해서 함께한다. 이 책을 학습하는 도중 6장에서 DAO(Data Accesss Object)로 인해 데이터베이스에 직접적으로 영향을 받는 테스트가 있었다. 이 테스트를 다른 의존관계와 고립시키기 위해 DAO를 목(Mock)으로 변환하는 과정을 거치면서, 지난 면접 자리에서 내 대답은 **단위 테스트** 본래의 목적에는 부합하지 않는 대답이라는 생각이 들었다. 이번이 3번째인가 4번째 다시 보는 책인 것 같은데 볼 때 마다 다시 배우는 기분이다. 단위테스트와 통합테스트에 대해 잘 비교한 내용이 있어 이를 기록한다.



## [토비의스프링](http://book.naver.com/bookdb/book_detail.nhn?bid=7006516)

### 6장 AOP - 6.2.3 단위테스트와 통합 테스트(P.423~425) 인용

단위테스트의 단위는 정하기 나름이다. 사용자 관리 기능 전체를 하나의 단위로 볼 수도 있고 하나의 클래스나 하나의 메소드를 단위로 볼 수도 있다. 중요한 것은 하나의 단위에 초점을 맞춘 테스트라는 점이다. (중략) 이 책에서는 앞으로 upgradeLevels() 테스트처럼 '테스트 대상 클래스를 목 오브젝트 등의 테스트 대역을 이용해 의존 오브젝트나 외부의 리소스를 사용하지 않도록 고립시켜서 테스트 하는 것'을 단위테스트라고 부르겠다. 반면에 두 개 이상의, 성격이나 계층이 다른 오브젝트가 연동하도록 만들어 테스트하거나, 또는 외부의 DB나 파일, 서비스 등의 리소스가 참여하는 테스트는 통합테스트라고 부르겠다.

- 항상 단위 테스트를 먼저 고려한다.
- 하나의 클래스나 성격과 목적이 같은 긴밀한 클래스 몇 개를 모아서 외부와의 외존관계를 모두 차단하고 필요에 따라 스텁이나 목 오브젝트 등의 테스트 대역을 이용하도록 테스트를 만든다. 단위 테스트는 테스트 작성도 간단하고 실행 속도도 빠르며 테스트 대상 외의 코드나 환경으로부터 테스트 결과에 영향을 받지도 않기 때문에 가장 빠른 시간에 효과적인 테스트를 작성하기 유리하다.
- 외부 리소스를 사용해야만 가능한 테스트는 통합 테스트로 만든다.
- 단위 테스트로 만들기가 어려운 코드도 있다. 대표적인 게 DAO다.  DAO는 그 자체로 로직을 담고 있기보다는 DB를 통해 로직을 수행하는 인터페이스와 같은 역할을 한다. SQL을 JDBC를 통해 실행하는 코드만으로는 고립된 테스트를 작성하기 힘들다. 작성한다고 해도 가치가 없는 경우가 대부분이다. 따라서 DAO는 DB까지 연동하는 테스트로 만든는 편이 효과적이다. DB를 사용하는 테스트는 DB에 테스트 데이터를 준비하고, DB에 직접 확인을 하는 등의 부가적인 작업이 필요하다.
- DAO 테스트는 DB라는 외부 리소스를 사용하기 때문에 통합테스트로 분류된다. 하지만 코드에서 보자면 하나의 기능단위를 테스트하는 것이기도 하다. DAO를 테스트를 통해 충분히 검증해두면, DAO를 이용하는 코드는 DAO 역할을 스텁이나 목 오브젝트로 대체해서 테슽흐라 수 있다. 이후에 실제 DAO와 연동했을 때도 바르게 동작하리라고 확신할 수 있다. 물론 각각의 단위 테스트가 성공했더라도 여러 개의 단위를 연결해서 테스트하면 오류가 발생할 수도 있다. 하지만 충분히 단위 테스트를 거친다면 통합 테스트에서 오류가 발생할 확률도 줄어들고 발생한다고 하더라도 쉽게 처리할 수 있다.
- 여러 개의 단위가 의존관계를 가지고 동작할 때를 위한 통합 테스트는 필요하다. 다만, 단위 테스트를 충분히 거쳤다면 통합 테스트이 부담은 상대적으로 줄어든다.
- 단위 테스트를 만들기가 너무 복잡하다고 판단되는 코드는 처음부터 통합 테스트를 고려해 본다. 이때도 통합 테스트에 참여하는 코드 중에서 가능한 한 많은 부분을 미리 단위테스트로 검증해 두는게 유리하다.
- 스프링 테스트 컨텍스트 프레임워크를 이용하는 테스트는 통합 테스트다. 가능하면 스프링의 지원 없이 직접 코드 레벨의 DI를 사용하면서 단위테스트를 하는 게 좋겠다만 스프링의 설정 자체도 테스트 대상이고, 스프링을 이용해 좀 더 추상적인 레벨에서 테스트해야 할 경우도 종종 있다. 이럴 땐 스프링 테스트 컨텍스트 프레임워크를 이용해 통합 테스트를 작성한다.